<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KKday 福岡一日遊 (神話特化版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f9ff;
        }
        .card-highlight {
            ring: 4px;
            ring-opacity: 0.8;
            transform: scale(1.02);
            transition: all 0.3s ease;
            opacity: 1 !important;
        }
        .card-dimmed {
            opacity: 0.4;
            transform: scale(0.98);
            transition: all 0.3s ease;
        }
        
        /* Advanced Table Badges */
        .badge { display: inline-flex; align-items: center; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; white-space: nowrap; }
        .badge-green { background-color: #dcfce7; color: #166534; }
        .badge-yellow { background-color: #fef9c3; color: #854d0e; }
        .badge-red { background-color: #fee2e2; color: #991b1b; }
        .badge-blue { background-color: #dbeafe; color: #1e40af; }
        .badge-indigo { background-color: #e0e7ff; color: #3730a3; }
        .badge-pink { background-color: #fce7f3; color: #9d174d; }
        .badge-purple { background-color: #f3e8ff; color: #6b21a8; }
        .badge-teal { background-color: #ccfbf1; color: #0f766e; }
        
        /* Table Optimization */
        .detail-row td { vertical-align: top; padding-top: 1rem; padding-bottom: 1rem; }
        
        /* Poll Styles */
        .poll-bar-container { background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; height: 1.5rem; position: relative; }
        .poll-bar { height: 100%; transition: width 1s ease-in-out; display: flex; align-items: center; justify-content: flex-end; padding-right: 0.5rem; color: white; font-size: 0.75rem; font-weight: bold; }
        .vote-btn:disabled { opacity: 0.5; cursor: not-allowed; background-color: #9ca3af; color: #fff; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Navbar -->
    <nav class="bg-indigo-900 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-torii-gate text-2xl mr-2 text-red-400"></i>
                    <span class="font-bold text-xl">九州神話與秘境攻略</span>
                </div>
                <div class="text-sm hidden sm:block">KKday 精選</div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="bg-indigo-800 text-white py-12 px-4 text-center">
        <h1 class="text-3xl md:text-4xl font-bold mb-4">尋找「天安河原」與「螢火之森」</h1>
        <p class="text-indigo-200 max-w-2xl mx-auto text-lg">
            為您找出包含【天安河原】與【上色見熊野座神社】的特殊行程，體驗九州最強能量景點。
        </p>

        <!-- Interactive Filter -->
        <div class="mt-8 bg-white/10 backdrop-blur-md p-6 rounded-xl max-w-5xl mx-auto border border-white/20">
            <h3 class="text-lg font-bold mb-4"><i class="fas fa-magic mr-2"></i>您想去哪裡？(點擊篩選)</h3>
            <div class="flex flex-wrap justify-center gap-3" id="filters">
                <button onclick="highlight('myth-full')" class="px-4 py-2 bg-white text-indigo-700 rounded-full font-bold hover:bg-purple-500 hover:text-white transition shadow border-2 border-purple-500">
                    <i class="fas fa-star mr-1"></i> 神話全覽 (兩個都去)
                </button>
                <button onclick="highlight('myth-iwato')" class="px-4 py-2 bg-white text-teal-700 rounded-full font-bold hover:bg-teal-500 hover:text-white transition shadow">
                    <i class="fas fa-dungeon mr-1"></i> 只去天安河原 (+小火車)
                </button>
                <button onclick="highlight('myth-shrine')" class="px-4 py-2 bg-white text-green-700 rounded-full font-bold hover:bg-green-500 hover:text-white transition shadow">
                    <i class="fas fa-torii-gate mr-1"></i> 只去上色見 (+溫泉)
                </button>
                <div class="w-full h-0 md:hidden"></div> <!-- Break line on mobile -->
                <button onclick="highlight('classic')" class="px-4 py-2 bg-white text-blue-700 rounded-full font-bold hover:bg-blue-500 hover:text-white transition shadow">
                    <i class="fas fa-umbrella-beach mr-1"></i> 其他觀光 (無神話)
                </button>
                <button onclick="resetHighlight()" class="px-4 py-2 bg-gray-700 text-white rounded-full font-bold hover:bg-gray-600 transition shadow">
                    顯示全部
                </button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">

        <!-- SECTION 0: Voting Poll -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden mb-12 border border-gray-100">
            <div class="bg-gradient-to-r from-indigo-500 to-purple-500 p-4 text-white flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center">
                    <h2 id="poll-title" class="text-xl font-bold"><i class="fas fa-poll mr-2"></i>大家最想去哪裡？</h2>
                    <span class="ml-2 text-sm bg-white/20 px-3 py-1 rounded-full">累積 <span id="total-votes">0</span> 票</span>
                    <button onclick="resetPoll()" class="ml-3 text-xs bg-black/20 hover:bg-red-600/80 text-white px-2 py-1 rounded transition flex items-center" title="重置">
                        <i class="fas fa-trash-alt mr-1"></i> 重置
                    </button>
                </div>
                <div class="flex items-center w-full md:w-auto">
                    <div class="relative w-full">
                        <i class="fas fa-user absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="voter-name" placeholder="請輸入您的暱稱 (記名投票)" 
                            class="pl-10 pr-4 py-2 rounded-full text-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-white/50 w-full md:w-64 border-none shadow-inner bg-white/90">
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 divide-y md:divide-y-0 md:divide-x divide-gray-100">
                <div class="p-6 md:col-span-2" id="poll-container">
                    <div class="text-center text-gray-500 py-8 flex flex-col items-center justify-center">
                        <i class="fas fa-circle-notch fa-spin text-2xl mb-2 text-indigo-500"></i>
                        <span>初始化投票選項中...</span>
                    </div>
                </div>
                <div class="p-6 bg-gray-50/50">
                    <h3 class="text-sm font-bold text-gray-500 uppercase mb-3"><i class="fas fa-history mr-1"></i> 最新投票動態</h3>
                    <div id="poll-logs" class="space-y-3 text-sm">
                        <div class="text-center text-gray-400 py-4">暫無紀錄</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- SECTION 1: 卡片牆 (快速瀏覽) -->
        <div class="flex items-center mb-6">
            <div class="h-8 w-2 bg-indigo-500 rounded-full mr-3"></div>
            <h2 class="text-2xl font-bold text-gray-800">精選行程卡片</h2>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-6 mb-16" id="card-container">
            
            <!-- 1. Myth Full (182363) -->
            <div id="card-myth-full" class="tour-card bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col border-2 border-purple-500 ring-4 ring-purple-100 transform scale-[1.01]">
                <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white text-xs font-bold px-3 py-1 uppercase tracking-wide text-center">
                    ★ 許願款：兩個願望一次滿足
                </div>
                <div class="p-6 flex-1 flex flex-col">
                    <div class="flex justify-between items-start mb-2"><span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-mono font-bold">182363</span></div>
                    <div class="mb-3"><span class="text-2xl font-bold text-purple-600">NT$ 1,550</span> <span class="text-xs text-gray-500">起</span></div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">神話全覽：上色見＋天安河原</h3>
                    <div class="space-y-2 mb-6 flex-1 text-sm text-gray-700">
                        <div class="font-bold bg-purple-50 p-1 rounded"><i class="fas fa-torii-gate text-purple-600 w-5"></i> 上色見熊野座神社</div>
                        <div class="font-bold bg-indigo-50 p-1 rounded"><i class="fas fa-dungeon text-indigo-600 w-5"></i> 天安河原 (天岩戶)</div>
                        <div class="text-gray-500"><i class="fas fa-water w-5"></i> 高千穗峽 (散策)</div>
                    </div>
                    <a href="https://www.kkday.com/zh-tw/product/182363" target="_blank" class="block w-full text-center bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg">前往訂購</a>
                </div>
            </div>

            <!-- 2. Myth Iwato (181723) -->
            <div id="card-myth-iwato" class="tour-card bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col border border-gray-100 ring-teal-400">
                <div class="bg-teal-500 text-white text-xs font-bold px-3 py-1 uppercase tracking-wide text-center">
                    只去天安河原 ＋ 小火車
                </div>
                <div class="p-6 flex-1 flex flex-col">
                    <div class="flex justify-between items-start mb-2"><span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-mono font-bold">181723</span></div>
                    <div class="mb-3"><span class="text-2xl font-bold text-teal-500">NT$ 1,600</span> <span class="text-xs text-gray-500">起</span></div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">高千穗深度＆小火車</h3>
                    <div class="space-y-2 mb-6 flex-1 text-sm text-gray-700">
                        <div class="font-bold bg-teal-50 p-1 rounded"><i class="fas fa-dungeon text-teal-600 w-5"></i> 天安河原 (深度)</div>
                        <div class="font-bold bg-teal-50 p-1 rounded"><i class="fas fa-train text-teal-600 w-5"></i> 天空小火車 (選購)</div>
                        <div class="text-gray-400"><i class="fas fa-times-circle text-gray-300 w-5"></i> 不去上色見神社</div>
                    </div>
                    <a href="https://www.kkday.com/zh-tw/product/181723" target="_blank" class="block w-full text-center bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg">前往訂購</a>
                </div>
            </div>

            <!-- 3. Myth Shrine (150994) -->
            <div id="card-myth-shrine" class="tour-card bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col border border-gray-100 ring-green-500">
                <div class="bg-green-600 text-white text-xs font-bold px-3 py-1 uppercase tracking-wide text-center">
                    只去上色見 ＋ 黑川溫泉
                </div>
                <div class="p-6 flex-1 flex flex-col">
                    <div class="flex justify-between items-start mb-2"><span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-mono font-bold">150994</span></div>
                    <div class="mb-3"><span class="text-2xl font-bold text-green-600">NT$ 1,900</span> <span class="text-xs text-gray-500">起</span></div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">黑川溫泉＆秘境神社</h3>
                    <div class="space-y-2 mb-6 flex-1 text-sm text-gray-700">
                        <div class="font-bold bg-green-50 p-1 rounded"><i class="fas fa-torii-gate text-green-600 w-5"></i> 上色見熊野座神社</div>
                        <div class="font-bold bg-green-50 p-1 rounded"><i class="fas fa-hot-tub text-green-600 w-5"></i> 黑川溫泉 (散策)</div>
                        <div class="text-gray-400"><i class="fas fa-times-circle text-gray-300 w-5"></i> 不去天安河原</div>
                    </div>
                    <a href="https://www.kkday.com/zh-tw/product/150994" target="_blank" class="block w-full text-center bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">前往訂購</a>
                </div>
            </div>

            <!-- 4. Itoshima (305739) -->
            <div id="card-photo" class="tour-card bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col border border-gray-100 ring-pink-400">
                <div class="bg-pink-500 text-white text-xs font-bold px-3 py-1 uppercase tracking-wide text-center">
                    其他觀光 • 海景網美
                </div>
                <div class="p-6 flex-1 flex flex-col">
                    <div class="flex justify-between items-start mb-2"><span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-mono font-bold">305739</span></div>
                    <div class="mb-3"><span class="text-2xl font-bold text-pink-500">NT$ 1,500</span> <span class="text-xs text-gray-500">起</span></div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">糸島絕景一日遊</h3>
                    <div class="space-y-2 mb-6 flex-1 text-sm text-gray-700">
                        <div class="font-bold bg-pink-50 p-1 rounded"><i class="fas fa-camera text-pink-500 w-5"></i> 櫻井二見浦</div>
                        <div class="text-gray-600"><i class="fas fa-tree w-5"></i> 龍貓森林</div>
                        <div class="text-gray-400"><i class="fas fa-ban w-5"></i> 無神話景點</div>
                    </div>
                    <a href="https://www.kkday.com/zh-tw/product/305739" target="_blank" class="block w-full text-center bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 px-4 rounded-lg">前往訂購</a>
                </div>
            </div>

            <!-- 5. Mojiko (304123) -->
            <div id="card-history" class="tour-card bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col border border-gray-100 ring-blue-500">
                <div class="bg-blue-600 text-white text-xs font-bold px-3 py-1 uppercase tracking-wide text-center">
                    其他觀光 • 懷舊港口
                </div>
                <div class="p-6 flex-1 flex flex-col">
                    <div class="flex justify-between items-start mb-2"><span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-mono font-bold">304123</span></div>
                    <div class="mb-3"><span class="text-2xl font-bold text-blue-600">NT$ 1,950</span> <span class="text-xs text-gray-500">起</span></div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">門司港＆唐戶市場</h3>
                    <div class="space-y-2 mb-6 flex-1 text-sm text-gray-700">
                        <div class="font-bold bg-blue-50 p-1 rounded"><i class="fas fa-fish text-blue-600 w-5"></i> 唐戶市場</div>
                        <div class="text-gray-600"><i class="fas fa-archway w-5"></i> 門司港懷舊區</div>
                        <div class="text-gray-400"><i class="fas fa-ban w-5"></i> 無神話景點</div>
                    </div>
                    <a href="https://www.kkday.com/zh-tw/product/304123" target="_blank" class="block w-full text-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">前往訂購</a>
                </div>
            </div>

            <!-- 6. Classic (119732) -->
            <div id="card-classic" class="tour-card bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col border border-gray-100 ring-green-500">
                <div class="bg-green-600 text-white text-xs font-bold px-3 py-1 uppercase tracking-wide text-center">
                    其他觀光 • 經典必遊
                </div>
                <div class="p-6 flex-1 flex flex-col">
                    <div class="flex justify-between items-start mb-2"><span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-mono font-bold">119732</span></div>
                    <div class="mb-3"><span class="text-2xl font-bold text-green-600">NT$ 1,800</span> <span class="text-xs text-gray-500">起</span></div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">由布院＆別府＆太宰府</h3>
                    <div class="space-y-2 mb-6 flex-1 text-sm text-gray-700">
                        <div class="font-bold bg-green-50 p-1 rounded"><i class="fas fa-torii-gate text-green-600 w-5"></i> 太宰府天滿宮</div>
                        <div class="text-gray-600"><i class="fas fa-shopping-bag w-5"></i> 由布院</div>
                        <div class="text-gray-400"><i class="fas fa-ban w-5"></i> 無秘境神社</div>
                    </div>
                    <a href="https://www.kkday.com/zh-tw/product/119732" target="_blank" class="block w-full text-center bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">前往訂購</a>
                </div>
            </div>

        </div>

        <!-- SECTION 2: 進階詳細版比較表 -->
        <div class="bg-indigo-800 text-white p-4 rounded-t-xl shadow-lg text-center">
            <h2 class="text-xl font-bold"><i class="fas fa-table mr-2"></i>神話景點比一比</h2>
            <p class="text-indigo-200 text-sm">看看哪個行程最符合您的需求</p>
        </div>

        <div class="bg-white border-x border-b border-gray-200 rounded-b-xl p-4 md:p-6 shadow-lg">
            
            <!-- Legend -->
            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mb-6 text-sm flex flex-wrap gap-4 items-center justify-center">
                <span class="font-bold text-gray-900">比較指標：</span>
                <span class="flex items-center"><i class="fas fa-torii-gate text-purple-600 mr-1"></i> 上色見神社</span>
                <span class="flex items-center"><i class="fas fa-dungeon text-teal-600 mr-1"></i> 天安河原</span>
                <span class="flex items-center"><i class="fas fa-train text-indigo-600 mr-1"></i> 小火車</span>
                <span class="flex items-center"><i class="fas fa-hot-tub text-green-600 mr-1"></i> 溫泉</span>
            </div>

            <!-- Desktop View Table -->
            <div class="hidden md:block bg-white rounded-xl shadow-sm overflow-hidden border border-gray-200">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-100 text-gray-600 text-sm uppercase tracking-wider border-b border-gray-200">
                            <th class="p-4 w-2/12">行程名稱</th>
                            <th class="p-4 w-1/12 text-center bg-purple-50">上色見神社</th>
                            <th class="p-4 w-1/12 text-center bg-teal-50">天安河原</th>
                            <th class="p-4 w-1/12 text-center">小火車</th>
                            <th class="p-4 w-1/12 text-center">溫泉</th>
                            <th class="p-4 w-3/12">其他景點/特色</th>
                            <th class="p-4 w-1/12 text-center">連結</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 text-sm text-gray-700">
                        
                        <!-- 1. Myth All (182363) -->
                        <tr class="detail-row hover:bg-purple-50 transition bg-purple-50/30">
                            <td class="p-4 font-bold text-purple-700">神話全覽線 (182363)</td>
                            <td class="p-4 text-center text-lg bg-purple-50">✅</td>
                            <td class="p-4 text-center text-lg bg-teal-50">✅</td>
                            <td class="p-4 text-center text-gray-300">❌</td>
                            <td class="p-4 text-center text-gray-300">❌</td>
                            <td class="p-4 text-xs">
                                <strong>高效率行程！</strong><br>一天收集兩大神祕能量景點。
                            </td>
                            <td class="p-4 text-center"><a href="https://www.kkday.com/zh-tw/product/182363" target="_blank" class="text-purple-600 underline">查看</a></td>
                        </tr>

                        <!-- 2. Train (181723) -->
                        <tr class="detail-row hover:bg-teal-50 transition">
                            <td class="p-4 font-bold text-teal-700">鐵道深度線 (181723)</td>
                            <td class="p-4 text-center text-gray-300 bg-purple-50">❌</td>
                            <td class="p-4 text-center text-lg bg-teal-50">✅</td>
                            <td class="p-4 text-center text-lg">✅</td>
                            <td class="p-4 text-center text-gray-300">❌</td>
                            <td class="p-4 text-xs">
                                <strong>適合親子/鐵道迷。</strong><br>高千穗深度遊，搭乘天空小火車。
                            </td>
                            <td class="p-4 text-center"><a href="https://www.kkday.com/zh-tw/product/181723" target="_blank" class="text-teal-600 underline">查看</a></td>
                        </tr>

                        <!-- 3. Shrine (150994) -->
                        <tr class="detail-row hover:bg-green-50 transition">
                            <td class="p-4 font-bold text-green-700">秘境溫泉線 (150994)</td>
                            <td class="p-4 text-center text-lg bg-purple-50">✅</td>
                            <td class="p-4 text-center text-gray-300 bg-teal-50">❌</td>
                            <td class="p-4 text-center text-gray-300">❌</td>
                            <td class="p-4 text-center text-lg">✅</td>
                            <td class="p-4 text-xs">
                                <strong>療癒放鬆。</strong><br>去完上色見神社後，到黑川溫泉泡湯散步。
                            </td>
                            <td class="p-4 text-center"><a href="https://www.kkday.com/zh-tw/product/150994" target="_blank" class="text-green-600 underline">查看</a></td>
                        </tr>

                        <!-- Others -->
                        <tr class="detail-row text-gray-400">
                            <td class="p-4">其他觀光行程</td>
                            <td class="p-4 text-center bg-purple-50">❌</td>
                            <td class="p-4 text-center bg-teal-50">❌</td>
                            <td class="p-4 text-center">❌</td>
                            <td class="p-4 text-center">-</td>
                            <td class="p-4 text-xs">糸島、門司港、由布院等一般觀光路線。</td>
                            <td class="p-4 text-center">-</td>
                        </tr>

                    </tbody>
                </table>
            </div>
            
            <div class="mt-6 text-center text-gray-400 text-xs">
                資料來源：KKday 官網頁面整理，內容可能隨季節變動，請以訂購當下資訊為準。
                <div class="mt-2 text-gray-500 font-bold">Ver 2.3 (Fix)</div>
            </div>

        </div>

        <div class="mt-8 text-center text-gray-500 text-sm">
            <p>※ 金額為預估參考，實際價格會隨匯率與季節波動，請依 KKday 官網即時資訊為主。</p>
        </div>

    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-2xl transform translate-y-20 transition-transform duration-300 z-50 flex items-center">
        <i class="fas fa-check-circle text-green-400 mr-2"></i>
        <span>已為您篩選！</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, increment, setDoc, getDoc, collection, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 設定與變數 ---
        const POLL_VERSION = 'v2.3'; 
        
        // Poll Options Configuration
        const pollOptions = [
            { id: '182363', name: '神話全覽 (上色見+天安河原)', color: 'bg-purple-600' },
            { id: '181723', name: '鐵道深度 (天安河原only)', color: 'bg-teal-500' },
            { id: '150994', name: '秘境溫泉 (上色見only)', color: 'bg-green-500' },
            { id: '305739', name: '糸島網美線', color: 'bg-pink-500' },
            { id: '304123', name: '門司港懷舊線', color: 'bg-blue-600' },
            { id: '119732', name: '經典由布院', color: 'bg-green-600' }
        ];

        let db, auth, appId;
        let isLocalMode = false;

        // 1. Initial Render (Show UI immediately)
        function renderInitialUI() {
             renderPoll({}); 
             document.getElementById('poll-logs').innerHTML = '<div class="text-center text-gray-400 py-4">載入即時動態中...</div>';
        }

        // 2. Initialize System
        async function initSystem() {
            try {
                // User provided config
                const firebaseConfig = {
                    apiKey: "AIzaSyAGHMP1HLJJPRQD_9CXnwI6lQwkcbZNm8M",
                    authDomain: "fukuoka-tour-vote.firebaseapp.com",
                    projectId: "fukuoka-tour-vote",
                    storageBucket: "fukuoka-tour-vote.firebasestorage.app",
                    messagingSenderId: "997387578824",
                    appId: "1:997387578824:web:1006cda95b7fe7508d24fd"
                };

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // Use fixed ID + Version for data location
                appId = 'fukuoka-public-vote-' + POLL_VERSION; 

                // Auth Flow
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                // Wait for Auth
                await new Promise((resolve, reject) => {
                    const unsubscribe = onAuthStateChanged(auth, (user) => {
                        if (user) { unsubscribe(); resolve(user); }
                    }, (err) => reject(err));
                });

                // Listen to Real DB
                const pollRef = doc(db, 'artifacts', appId, 'public', 'data', 'poll_results', 'current');
                
                // Use onSnapshot immediately without blocking check
                onSnapshot(pollRef, (docSnap) => {
                    const data = docSnap.exists() ? docSnap.data() : {};
                    renderPoll(data);
                    renderLogs(data.logs || []);
                }, (error) => {
                    console.warn("Snapshot failed, falling back to local:", error);
                    initLocalMode();
                });

            } catch (error) {
                console.log("Firebase init failed or local mode requested:", error);
                initLocalMode();
            }
        }

        // 3. Local Mode Logic (Fallback)
        function initLocalMode() {
            isLocalMode = true;
            console.log("Running in Local Mode");
            
            // Show indicator safely using ID
            const titleContainer = document.getElementById('poll-title');
            if(titleContainer && !titleContainer.innerHTML.includes('單機')) {
                 titleContainer.innerHTML += ' <span class="text-xs bg-white/20 px-2 py-1 rounded ml-2 border border-white/30">(單機版)</span>';
            }

            // Load data from localStorage
            loadLocalData();
        }

        function loadLocalData() {
            // Include version in local storage key to support reset
            const localData = JSON.parse(localStorage.getItem('kkday_poll_data_' + POLL_VERSION) || '{"logs": []}');
            renderPoll(localData);
            renderLogs(localData.logs || []);
        }

        // 4. Reset Function (Global/Local)
        window.resetPoll = async () => {
            if(!confirm('確定要重置所有投票數據嗎？這將清除所有人的投票紀錄。')) return;

            // Clear local locks
            localStorage.removeItem(`has_voted_${POLL_VERSION}`);
            pollOptions.forEach(opt => localStorage.removeItem(`voted_${opt.id}_${POLL_VERSION}`));

            if(isLocalMode) {
                // Local Mode Reset
                localStorage.removeItem('kkday_poll_data_' + POLL_VERSION);
                loadLocalData();
                alert('本地數據已重置！');
            } else {
                // Firebase Reset
                try {
                    const pollRef = doc(db, 'artifacts', appId, 'public', 'data', 'poll_results', 'current');
                    // Reset doc to empty or initial state - overwrite with empty logs
                    await setDoc(pollRef, { logs: [] }); 
                    // Note: count fields will be removed by setDoc without merge:true
                    alert('全域投票數據已重置！');
                } catch(e) {
                    console.error(e);
                    alert('重置失敗，請檢查權限');
                }
            }
        };

        // 5. Vote Handler
        window.vote = async (id) => {
            const nameInput = document.getElementById('voter-name');
            const name = nameInput.value.trim();

            if (!name) {
                alert('請先輸入您的暱稱，才能進行記名投票喔！');
                nameInput.focus();
                return;
            }

            // Check restriction: One vote per device (browser) for this POLL_VERSION
            if (localStorage.getItem(`has_voted_${POLL_VERSION}`)) {
                alert(`您已經在本裝置投過票囉！若要重投請點擊標題旁的重置按鈕。`);
                return;
            }

            // Optimistic UI update trigger
            localStorage.setItem(`has_voted_${POLL_VERSION}`, 'true');
            // Also set per-option for button UI state
            localStorage.setItem(`voted_${id}_${POLL_VERSION}`, 'true');

            if (isLocalMode) {
                // Handle Local Vote
                const localData = JSON.parse(localStorage.getItem('kkday_poll_data_' + POLL_VERSION) || '{"logs": []}');
                
                // Increment count
                localData['count_' + id] = (localData['count_' + id] || 0) + 1;
                
                // Add log
                if (!localData.logs) localData.logs = [];
                localData.logs.push({
                    name: name,
                    optionId: id,
                    timestamp: Date.now()
                });

                localStorage.setItem('kkday_poll_data_' + POLL_VERSION, JSON.stringify(localData));
                loadLocalData(); // Re-render
                
            } else {
                // Handle Firebase Vote
                try {
                    const pollRef = doc(db, 'artifacts', appId, 'public', 'data', 'poll_results', 'current');
                    
                    // Create doc if needed logic is handled by setDoc with merge
                    await setDoc(pollRef, {
                        ['count_' + id]: increment(1),
                        logs: arrayUnion({
                            name: name,
                            optionId: id,
                            timestamp: Date.now()
                        })
                    }, { merge: true });
                } catch (e) {
                    console.error("Vote failed", e);
                    alert("連線失敗，切換為單機模式");
                    // Revert lock
                    localStorage.removeItem(`has_voted_${POLL_VERSION}`);
                    
                    initLocalMode(); // Fallback on failure
                }
            }
        };

        // Render Functions
        function renderPoll(data) {
            const container = document.getElementById('poll-container');
            const totalDisplay = document.getElementById('total-votes');
            
            let totalVotes = 0;
            pollOptions.forEach(opt => {
                totalVotes += (data['count_' + opt.id] || 0);
            });
            
            if(totalDisplay) totalDisplay.innerText = totalVotes;

            let html = '';
            pollOptions.forEach(opt => {
                const count = data['count_' + opt.id] || 0;
                const percentage = totalVotes === 0 ? 0 : Math.round((count / totalVotes) * 100);
                // Check if voted specifically for this option in this version (for UI highlight)
                const hasVotedThis = localStorage.getItem(`voted_${opt.id}_${POLL_VERSION}`);
                // Check if voted at all (to disable other buttons)
                const hasVotedAny = localStorage.getItem(`has_voted_${POLL_VERSION}`);
                
                // Safety check for width to avoid layout break
                const barWidth = percentage < 1 ? 1 : percentage; 

                html += `
                    <div class="mb-3">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold text-gray-700 text-sm">${opt.name}</span>
                            <span class="text-xs text-gray-500">${count} 票 (${percentage}%)</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="flex-grow poll-bar-container bg-gray-200 rounded-full h-4 overflow-hidden relative">
                                <div class="poll-bar ${opt.color} h-full transition-all duration-1000 ease-out" style="width: ${barWidth}%"></div>
                            </div>
                            <button onclick="vote('${opt.id}')" 
                                class="vote-btn px-3 py-1 rounded text-xs font-bold transition shadow ${hasVotedThis ? 'bg-gray-800 text-white' : (hasVotedAny ? 'bg-gray-300 text-gray-500' : 'text-white ' + opt.color + ' hover:brightness-110')}"
                                ${hasVotedAny ? 'disabled' : ''}>
                                ${hasVotedThis ? '已投' : '投票'}
                            </button>
                        </div>
                    </div>
                `;
            });
            if(container) container.innerHTML = html;
        }

        function renderLogs(logs) {
            const logsContainer = document.getElementById('poll-logs');
            if (!logsContainer) return;
            
            if (!logs || logs.length === 0) {
                logsContainer.innerHTML = '<div class="text-center text-gray-400 py-4">暫無紀錄，快來投第一票！</div>';
                return;
            }

            const recentLogs = logs.sort((a, b) => b.timestamp - a.timestamp).slice(0, 5);

            let html = '';
            recentLogs.forEach(log => {
                const option = pollOptions.find(o => o.id === log.optionId);
                const colorClass = option ? option.color.replace('bg-', 'text-') : 'text-gray-600';
                
                // Time formatting
                const now = Date.now();
                const diffMs = now - log.timestamp;
                const diffMins = Math.floor(diffMs / 60000);
                let timeText = '剛剛';
                if (diffMins > 0) {
                    if (diffMins < 60) timeText = `${diffMins} 分鐘前`;
                    else timeText = `${Math.floor(diffMins/60)} 小時前`;
                }

                // Sanitize input to prevent XSS (basic)
                const safeName = (log.name || '匿名').replace(/</g, "&lt;").replace(/>/g, "&gt;");

                html += `
                    <div class="flex items-center justify-between border-b border-gray-100 pb-2 last:border-0">
                        <div class="flex items-center">
                            <div class="w-2 h-2 rounded-full ${option ? option.color : 'bg-gray-400'} mr-2"></div>
                            <div>
                                <span class="font-bold text-gray-700 text-xs">${safeName}</span>
                                <span class="text-xs text-gray-400 transform scale-90 origin-left inline-block">投給了</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="font-bold text-xs ${colorClass}">${option ? option.name : '未知行程'}</span>
                            <div class="text-[10px] text-gray-400">${timeText}</div>
                        </div>
                    </div>
                `;
            });
            logsContainer.innerHTML = html;
        }

        // Highlighting Logic (Feature)
        function highlight(type) {
            resetStyles();
            
            // CORRECTED MAP button types to card IDs
            const mapping = {
                'myth-full': ['card-myth-full'], 
                'myth-iwato': ['card-myth-iwato'], 
                'myth-shrine': ['card-myth-shrine'], 
                'classic': ['card-classic', 'card-photo', 'card-history'], 
                'photo': ['card-photo'],
                'history': ['card-history'], 
            };

            // If user selects "Other", highlight all non-myth
            if (type === 'classic') {
               mapping['classic'].forEach(id => document.getElementById(id)?.classList.add('card-highlight'));
               // Dim others
               document.querySelectorAll('.tour-card').forEach(c => {
                   if(!mapping['classic'].includes(c.id)) c.classList.add('card-dimmed');
               });
               return;
            }

            const target = mapping[type];
            if (!target) return;

            const cards = document.querySelectorAll('.tour-card');
            cards.forEach(c => {
                let shouldHighlight = false;
                if (target.includes(c.id)) {
                    shouldHighlight = true;
                }

                if (shouldHighlight) {
                    c.classList.add('card-highlight');
                } else {
                    c.classList.add('card-dimmed');
                }
            });
        }

        function resetHighlight() {
            resetStyles();
        }

        function resetStyles() {
            const cards = document.querySelectorAll('.tour-card');
            cards.forEach(card => {
                card.classList.remove('card-highlight', 'card-dimmed');
                // Removed opacity classes logic as we use CSS classes now
            });
        }

        // Start
        renderInitialUI();
        initSystem();
    </script>
</body>
</html>


